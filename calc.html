<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title></title>
    <link href="css/style.css" rel="stylesheet" />
    <style>
        .servant tr:nth-child(2) td:nth-child(odd) {
            width: 10%;
        }

        .servant tr:nth-child(2) td:nth-child(even) {
            width: 15%;
        }
/*
        .servant tr:nth-child(2){
            text-align: center;
        }
*/ 
        .servant tr:nth-child(2)>td:nth-child(2) input{
            width:450px;
        }
		
    </style>
</head>
<body id="content" onunload="setStorage()">
    <div id="divServant">
        <table class="servant">
            <tr>
                <td colspan="8">
                    <select id="ddlChooseServant">
                        <option value="-1">|----------------------请选择从者-------------------------|</option>
                    </select>
                    <label for="ckIsMaxGrail">
                        <input type="checkbox" id="ckIsMaxGrail" />圣杯MAX</label>
                    <input type="text" id="txtWord" class="search" list="dlTips" autofocus />
                    <input type="button" id="btnSearch" value="查询" />&nbsp;
                    <datalist id="dlTips"></datalist>
                    <datalist id="dlCraftEssenceTips"></datalist>
                </td>
            </tr>
            <tr>
                <td>阵营</td>
                <td><span id="spanAttribute"></span></td>  
                <td>属性</td>
                <td><span id="spanAlignments"></span></td>
		<td>目标数</td>
		<td>
		    <input type="number" id="txtNTarget" />
		</td>
		<td>Hit数</td>
                <td>
                    <input type="text" id="txtNHits" size= 10px />
		    <input type="button" value="全鞭尸" id="btnAdjOk" onclick="adjOk()" />
                </td>
            </tr>           
            <tr>
                <td>等级</td>
                <td>
                    <select id="ddlLvs">
                        <option value="-1">默认</option>
                        <option value="100">Lv.100</option>
                        <option value="90">Lv.90</option>
                        <option value="80">Lv.80</option>
                        <option value="70">Lv.70</option>
                        <option value="65">Lv.65</option>
                        <option value="60">Lv.60</option>
                    </select>   
                </td>
                <td>攻击力</td>
                <td>
                    <input type="number" id="txtAttack" />
                </td>
                <td>Hp最大值</td>
                <td>
                    <input type="number" id="txtMaxHp" />
                </td>
                <td>剩余Hp值</td>
                <td>
                    <input type="number" id="txtRemainHp" />
                </td>                

            </tr>
            <tr>
                <td>芙芙Atk</td>
                <td>
                    <input type="number" id="txtFufuAtk" value="1000" />
                </td>
                <td>芙芙Hp</td>
                <td>
                    <input type="number" id="txtFufuHp" value="1000" />
                </td>

                <td>礼装Atk</td>
                <td>
                    <input type="number" id="txtCardAtk" value="0" list="dlCraftEssenceTips"/>
                </td>
                <td>礼装Hp</td>
                <td>
                    <input type="number" id="txtCardHp" value="0" />
                </td>
            </tr>            



            <tr>
                <td>卡色</td>
                <td>
                    <select id="ddlCardColor">
                        <option value="0.8">Quick</option>
                        <option value="1">Arts</option>
                        <option value="1.5">Buster</option>
                    </select>
                </td>
                <td>宝具等级</td>
                <td>
                    <select id="ddlNpLevel">
                        <option value="NP1">1</option>
                        <option value="NP2">2</option>
                        <option value="NP3">3</option>
                        <option value="NP4">4</option>
                        <option value="NP5">5</option>
                    </select>
                </td>
                <td>宝具倍率(%)</td>
                <td>
                    <input type="text" id="txtNpRate" />
                </td>
                <td>OC等级</td>
                <td>
                    <select id="ddlOc" oldvalue = "oc1">
                        <option value="oc1">1</option>
                        <option value="oc2">2</option>
                        <option value="oc3">3</option>
                        <option value="oc4">4</option>
                        <option value="oc5">5</option>
                    </select>
                    <label for="ckIsSpecialAttack">
                        <input type="checkbox" id="ckIsSpecialAttack" value="1" /> 特攻
                    </label>
		    <input type="button" value="满血" id="btnAdjHp" onclick="adjHp()" />
                </td>
            </tr>
            <tr>
                <td>从者职介</td>
                <td>
                    <select id="ddlCareer">
                        <option value="1.00">Saber</option>
                        <option value="0.95">Archer</option>
                        <option value="1.05">Lancer</option>
                        <option value="1.0">Rider</option>
                        <option value="0.9">Caster</option>
                        <option value="0.9">Assassin</option>
                        <option value="1.1">Berserker</option>
                        <option value="1.1">Ruler</option>
                        <option value="1.1">Avenger</option>
                        <option value="1.0">Shielder</option>
                        <option value="1.0">MoonCancer</option>
                        <option value="1.0">Alterego</option>
                        <option value="1.0">Foreigner</option>
                    </select>
                </td>            
                <td>职介克制</td>
                <td>
                    <select id="ddlCareerResist">
                        <option value="2.0">普通克制</option>
                        <option value="1.5">狂阶克制</option>
                        <option value="1.0">非克制</option>
			<option value="0.5">被克制</option>
                        <option value="1.2">Alterego-Beast III</option>
                    </select>
                </td>
                <td>阵营克制</td>
                <td>
                    <select id="ddlAttributeResist">
                        <option value="1.0">非克制</option>
                        <option value="1.1">克制</option>
                        <option value="0.9">被克制</option>
                    </select>
                </td>

                <td>宝具特攻(%)</td>
                <td>
                    <input type="text" id="txtNpSpecialAttack" value="100" />
                </td>
            </tr>


            <tr>
                <td>宝具威力Buff(%)</td>
                <td>
                    <input type="text" id="txtNpStrength" value="0"/>
                </td>
                <td>卡牌Buff(%)</td>
                <td>
                    <input type="text" id="txtCardBuff" value="0" data-value="0"/>
                </td>
                <td>攻击力Buff(%)</td>
                <td>
                    <input type="text" id="txtAttackBuff" value="0" />
                </td>
                <td>敌方防御力Buff(%)</td>
                <td>
                    <input type="text" id="txtEnemyDefence" value="0" />
                </td>
            </tr>
            <tr>
                <td>特攻威力Buff(%)</td>
                <td>
                    <input type="text" id="txtSpecialAttack" value="0" />
                </td>
                <td>固定伤害Buff</td>
                <td>
                    <input type="text" id="txtDamagePlus" value="0" basicvalue="0" />
                </td>
                <td>概念礼装</td>
                <td>
                    <select id="ddlCes">
                        <option value="0">自定义</option>
                        <option value="1">20级宝石</option>
                        <option value="2">100级醉贞</option>
                        <option value="3">100级空骑</option>
                        <option value="4">100级相扑</option>
                        <option value="5">80级黑杯</option>
			<option value="6">20级潜水学妹</option>
			<option value="7">20级北斋</option>
			<option value="8">15级泳装樱</option>
			<option value="9">100级轨迹</option>
                    </select>
                </td>
                <td>御主礼装</td>
                <td>
                    <select id="ddlCls">
                        <option value="0">无</option>
                        <option value="1">战斗服</option>
                        <option value="2">04服</option>
			<option value="3">骑士王服</option>
			<option value="4">初始服</option>
			<option value="5">西服</option>
			<option value="6">泳装</option>
			<option value="7">月海</option>
			<option value="8">月背</option>
			<option value="9">极地服</option>
			<option value="10">夏威夷衫</option>
			<option value="11">新年服</option>
			<option value="12">宇航服</option>
                    </select>
                </td>
            </tr>
	    <tr>
                <td>NP率(%)</td>
                <td>
                    <input type="text" id="txtNpGain" value="0" />
                </td>
		<td>敌人1</td>
		<td>
		    <select id="ddlEn1">
                        <option value="1.0">1.0</option>
                        <option value="0.8">0.8</option>
                        <option value="0.9">0.9</option>
                        <option value="1.1">1.1</option>
                        <option value="1.2">1.2</option>
                    </select>
		    <label for="ckEn1">
                        <input type="checkbox" id="ckEn1" value="1" /> 死灵
                    </label>
		</td>
		<td>敌人2</td>
		<td>
                    <select id="ddlEn2">
                        <option value="1.0">1.0</option>
                        <option value="0.8">0.8</option>
                        <option value="0.9">0.9</option>
                        <option value="1.1">1.1</option>
                        <option value="1.2">1.2</option>
                    </select>
                    <label for="ckEn2">
                        <input type="checkbox" id="ckEn2" value="1" /> 死灵
                    </label>
		</td>
                <td>敌人3</td>
                <td>
                    <select id="ddlEn3">
                        <option value="1.0">1.0</option>
                        <option value="0.8">0.8</option>
                        <option value="0.9">0.9</option>
                        <option value="1.1">1.1</option>
                        <option value="1.2">1.2</option>
                    </select>
                    <label for="ckEn3">
                        <input type="checkbox" id="ckEn3" value="1" /> 死灵
                    </label>
                </td>
	    </tr>
            <tr>
                <td>黄金律(%)</td>
                <td>
                    <input type="text" id="txtNpGainBuff" value="0" />
                </td>
                <td>敌人1鞭尸</td>
                <td>
                    <input type="number" id="txtEn1Overkill" value="0" />
                </td>
                <td>敌人2鞭尸</td>
                <td>
                    <input type="number" id="txtEn2Overkill" value="0" />
                </td>
                <td>敌人3鞭尸</td>
                <td>
                    <input type="number" id="txtEn3Overkill" value="0" />
                </td>
            </tr>
            <tr>
            </tr>
            <tr>
                <td colspan="8">
		    <input type="button" value="孔   明" id="btnAddKM" onclick="addKM()" />
		    <input type="button" value="梅   林" id="btnAddML" onclick="addML()" />	
		    <input type="button" value="狐   狸" id="btnAddHL" onclick="addHL()" />
		    <input type="button" value="斯卡蒂" id="btnAddCB" onclick="addCB()" />
		    <input type="button" value="清   空" id="btnClearBuff" onclick="resetBuff()" />
                    <input type="button" value="计   算" id="btnCalcute" onclick="calc()" />
                </td>
            </tr>
        </table>
    </div>
    <br />

    <div id="divResult" class="resultWrapper">
        <b>结果：<a href="javascript:;" onclick="clearTable(1)">清空</a></b>
        <table id="tbResult" class="result">
            <tr>
                <th>排名</th>
                <th>从者</th>
                <th>等级</th>
                <th>ATK</th>
                <th>阵营克制</th>
                <th>宝具等级</th>
                <th>宝具倍率</th>
                <th>宝具特攻(oc)</th>
                <th>宝具威力Buff</th>
                <th>卡牌Buff</th>
                <th>攻击力Buff</th>
                <th>特攻威力Buff</th>
                <th>敌方防御力Buff</th>
		<th>黄金律</th>
                <th>伤害最小值</th>
                <th>伤害平均值</th>
		<th>NP获取</th>
                <th>&nbsp;</th>
            </tr>
        </table>
    </div>
</body>
</html>
<script src="js/lvs.js"></script>
<script src="js/data.js"></script>
<script src="js/common.js"></script>
<script src="js/base.js"></script>
<script type="text/javascript">
    "use strict";
    /***********************************************************/
    initialData();
    initialServantList();
    loadStorage(true);
    bindSearchTips();

    (function(){
    })();

    //圣杯MAX勾选框改变事件
    $("ckIsMaxGrail").onchange = function () {
        let id = $("ddlChooseServant").value;
        if (id == "-1") {
            alert("请选择从者");
            return;
        }
        let servant = servants[id];
        let check = $("ckIsMaxGrail").checked;
        if (check) {
            $("txtAttack").value = servant.maxAtk;
            $("txtMaxHp").value = servant.maxHp;
            $("txtRemainHp").value = servant.maxHp;
            $("ddlLvs").selectedIndex=1;
        }
        else {
            $("txtAttack").value = servant.atk;
            $("txtMaxHp").value = servant.hp;
            $("txtRemainHp").value = servant.hp;
            $("ddlLvs").selectedIndex=0;
        }
    }
    //下拉从者选中项发生变化事件
    $("ddlChooseServant").onchange = function () {
        $("ckIsSpecialAttack").checked = false;
        $("ckIsMaxGrail").checked = false;
        $("txtDamagePlus").value = 0;
        $("txtCardBuff").dataset.value = 0;
        $("ddlLvs").selectedIndex=0;

        let id = this.value;
        if (id != "-1" && id != "") {
            clearBuff();
	    $("ddlOc").selectedIndex = 0;
	    $("ddlOc").oldvalue = "oc1";
            bindServantData(id);
	    changeOc();
        }
    }
    //宝具等级选中项发生变化事件
    $("ddlNpLevel").onchange = function () {
        changeNpRate();
    };

    //OC等级选中项发生变化事件
    $("ddlOc").onchange = function () {
        adjustOc();
	$("ddlOc").oldvalue = $("ddlOc").value;
    };
    //Hp值变动事件：动态计算双子宝具倍率
    $("txtRemainHp").onchange = function () {
        adjustOc();
    }
    $("txtFufuHp").onchange = function () {
        adjustOc();
    }
    $("txtCardHp").onchange = function () {
        adjustOc();
    }

    //是否特攻
    $("ckIsSpecialAttack").onclick = function () {
	let id=$("ddlChooseServant").value;
        if (id == "-1" || id == "") {
            return;
        }

        let servant = servants[id];
	let ocs = servant.oc;
        if(ocs["type"] == "NpSpecialAttack" || ocs["type"] == "SpecialAttackBuff") {
	    adjustOc(true);
	}
	else {
	    let npEffect = servant.npEffect;
	    if (npEffect && npEffect.specialAttack && !isNaN(npEffect.specialAttack)) {
        	//!isNaN(null)，返回true，需要去掉这种情况
                if($("ckIsSpecialAttack").checked) {
		    $("txtNpSpecialAttack").value = npEffect.specialAttack;
		}
		else {
		    $("txtNpSpecialAttack").value = 100;
		}
	    }
	    else {
		$("ckIsSpecialAttack").checked = false;
	    }
	}
    }

     //等级下拉列表选中项改变事件
    $("ddlLvs").onchange=function(){
        let id=$("ddlChooseServant").value;
        if (id == "-1" || id == "") {
            return;
        }

        let servant = servants[id];  

        let lv=this.value;
        //默认【圣杯MAX】非勾选状态
        $("ckIsMaxGrail").checked=false;

        if(lv!="-1"){//非默认
            // console.log(servant.lvs[lv-1]);
	    let mlv=0;
	    if(servant.star<4){
		mlv=servant.star*5+55;
	    }
	    else {
		mlv=servant.star*10+40;
	    }
	    if(Number(lv)<=mlv){
		$("txtAttack").value=servant.atk;
		$("txtMaxHp").value=servant.hp;
		$("txtRemainHp").value=servant.hp;
	    }
	    else if(Number(lv)>90){
                $("txtAttack").value=servant.maxAtk;
                $("txtMaxHp").value=servant.maxHp;
                $("txtRemainHp").value=servant.maxHp;
            }
	    else if(servant.star>1){
                lv=servant.lvs[0];
                $("txtAttack").value=lv.a;
                $("txtMaxHp").value=lv.h;
                $("txtRemainHp").value=lv.h;
	        $("ddlLvs").selectedIndex=2;
	    }
	    else if(Number(lv)>70){
                lv=servant.lvs[1];
                $("txtAttack").value=lv.a;
                $("txtMaxHp").value=lv.h;
                $("txtRemainHp").value=lv.h;
                $("ddlLvs").selectedIndex=2;
            }
	    else {
                lv=servant.lvs[0];
                $("txtAttack").value=lv.a;
                $("txtMaxHp").value=lv.h;
                $("txtRemainHp").value=lv.h;
                $("ddlLvs").selectedIndex=4;
            }
            if($("txtAttack").value==servant.maxAtk){
                $("ckIsMaxGrail").checked=true;
                $("ckIsMaxGrail").onchange();
            }
            else if($("txtAttack").value==servant.atk){
            	$("ddlLvs").selectedIndex=0;//默认
            }
        }
        else{//默认
            $("txtAttack").value=servant.atk;
            $("txtMaxHp").value=servant.hp;
            $("txtRemainHp").value=servant.hp;   
        }
    }

    $("ddlCes").onchange=function(){
	switch($("ddlCes").value) {
	    case "1":
		$("txtCardAtk").value=786;
		$("txtCardHp").value=0;
		break;
	    case "2":
	    case "3":
	    case "4":
	    case "9":
	    	$("txtCardAtk").value=2000;
		$("txtCardHp").value=0;
                break;
	    case "5":
		$("txtCardAtk").value=2034;
                $("txtCardHp").value=0;
                break;
	    case "6":
	    case "7":
		$("txtCardAtk").value=393;
		$("txtCardHp").value=629;
		break;
	    case "8":
		$("txtCardAtk").value=0;
		$("txtCardHp").value=1067;
		break;
	}
	adjustOc();
    }

    /***********************************************************/



    //绑定从者基本信息
    function bindServantData(id) {
        let servant = servants[id];
        //0.阵营
        $("spanAttribute").innerHTML = "<a href='javascript:;' data-value='@" + servant.attribute + "' onclick='autoClickSearch(this)'>" + servant.attribute + "</a>"

	$("txtNTarget").value = servant.target;
	$("txtNHits").value = servant.hit;
	$("txtNpGain").value = servant.np;
	$("txtNpGainBuff").value = 0;
	$("txtEn1Overkill").value = 0;
	$("txtEn2Overkill").value = 0;
	$("txtEn3Overkill").value = 0;

        //1.攻击力
        $("txtAttack").value = servant.atk;

        //2.Hp最大值、剩余Hp值
        $("txtMaxHp").value = servant.hp;
        $("txtRemainHp").value = servant.hp + 1000;

        //3.宝具倍率
        changeNpRate(servant);

        //4.卡色
        document.querySelector("#ddlCardColor option[value='" + servant.cardColor + "']").selected = true;

        //5.从者职介
        let Classs = $("ddlCareer").options;
        for (let i = 0; i < Classs.length; i++) {
            let Class = Classs[i];
            if (Class.text == servant.Class) {
                Class.selected = true;
            }
        }

        //6.职介技能
        bindServantCareerSkillInfo(servant);

        //7.宝具副效果补充(oc特攻只能展示一种副效果，如：1001的oc特攻只展示了宝具特攻，副效果的20宝具威力buff没展示，在这进行补充)
        bindNpSideEffect(servant);

        //8.属性
        bindAlignments(servant);
    }



    //宝具副效果补充
    function bindNpSideEffect(servant) {
        let npEffect = servant.npEffect;
        if (npEffect) {
            let npStrength = npEffect.npStrength;//宝具威力buff
            //!isNaN(null)，返回true，需要去掉这种情况
            if (npStrength && !isNaN(npStrength)) {//单个数值，比如1001宝具的20%宝具威力buff
                $("txtNpStrength").value = npStrength;
            }

            let cardBuff = npEffect.cardBuff;//卡牌buff
            if (cardBuff && !isNaN(cardBuff)) {//单个数值，比如剑兰宝具的30%蓝魔放buff
                $("txtCardBuff").value = cardBuff;
            }

        }

    }

    //绑定从者职介信息
    function bindServantCareerSkillInfo(servant) {
        //{ cardColor: 1, cardBuff: 10, damagePlus: 0}
        let ClassSkill = servant.ClassSkill;

        if (ClassSkill) {
            let cardColorValue = getFloat("ddlCardColor");
            let cardBuffs = ClassSkill.cardBuff;
            if (isNaN(cardBuffs)) {//"12|11"
                cardBuffs = ClassSkill.cardBuff.split('|');
            }

            let cardColor = ClassSkill.cardColor;
            /************************************卡牌Buff******************************************************/
            //0.8(Quick)，1(Arts)，1.5(Buster)，0(All)，-1(None)，-2(Quick和Arts)，-3(Buster和Quick), -4(Buster和Arts)
            if ((cardColor == 0.8 || cardColor == 1 || cardColor == 1.5) && cardColor == cardColorValue) {
                $("txtCardBuff").dataset.value = ClassSkill.cardBuff;

                $("txtCardBuff").value = ClassSkill.cardBuff;
            }
            else if (cardColor == 0) {//215
                $("txtCardBuff").dataset.value = ClassSkill.cardBuff;

                $("txtCardBuff").value = ClassSkill.cardBuff;
            }
                //Quick和Arts
            else if (cardColor == -2 && cardColorValue == 0.8 && cardBuffs && cardBuffs.length == 2) {
                let quickBuff = cardBuffs[0];
                $("txtCardBuff").dataset.value = quickBuff;

                $("txtCardBuff").value = quickBuff;
            }
            else if (cardColor == -2 && cardColorValue == 1 && cardBuffs && cardBuffs.length == 2) {
                let artsBuff = cardBuffs[1];
                $("txtCardBuff").dataset.value = artsBuff;

                $("txtCardBuff").value = artsBuff;
            }
                //Buster和Quick
            else if (cardColor == -3 && cardColorValue == 1.5 && cardBuffs && cardBuffs.length == 2) {
                let busterBuff = cardBuffs[0];
                $("txtCardBuff").dataset.value = busterBuff;

                $("txtCardBuff").value = busterBuff;
            }
            else if (cardColor == -3 && cardColorValue == 0.8 && cardBuffs && cardBuffs.length == 2) {
                let quickBuff = cardBuffs[1];
                $("txtCardBuff").dataset.value = quickBuff;

                $("txtCardBuff").value = quickBuff;
            }     
			//Buster和Arts
            else if (cardColor == -4 && cardColorValue == 1.5 && cardBuffs && cardBuffs.length == 2) {
                let busterBuff = cardBuffs[0];
                $("txtCardBuff").dataset.value = busterBuff;

                $("txtCardBuff").value = busterBuff;
            }
            else if (cardColor == -4 && cardColorValue == 1 && cardBuffs && cardBuffs.length == 2) {
                let artsBuff = cardBuffs[1];
                $("txtCardBuff").dataset.value = artsBuff;

                $("txtCardBuff").value = artsBuff;
            }
            /****************************************固定伤害Buff**************************************************/
            if (!isNaN(ClassSkill.damagePlus)) {
				$("txtDamagePlus").basicvalue = ClassSkill.damagePlus;
                $("txtDamagePlus").value = ClassSkill.damagePlus;
            }
        }

    }


    //计算双子宝具总倍率
    function calNpRemainHpDamageRate() {
        let ocLevel = $("ddlOc").value;
        let id = $("ddlChooseServant").value;
        let servant = servants[id];
        let ocs = servant.oc;

        let NP = $("ddlNpLevel").value;
        //原宝具倍率
        let npRate = servant.NP[NP];

        //附加倍率《超蓄力威力提升》 (此倍率×自身已损失HP所占百分比,与宝具倍率加算)
        //【※总倍率＝攻击倍率+HP特攻倍率*(1—现在HP/最大HP)】
        let maxHp = getFloat("txtMaxHp");
        let fufuHp = getFloat("txtFufuHp");
        let cardHp = getFloat("txtCardHp");
        let totalHp = maxHp + fufuHp + cardHp;

        let remainHp = getFloat("txtRemainHp");
        //附加倍率
        let additionalRate = ocs[ocLevel] * (1 - remainHp / totalHp);

        //总宝具倍率
        npRate += additionalRate;
        //向下取整总宝具倍率
        $("txtNpRate").value = Math.floor(npRate);

    }
    //计算自爆弓宝具总倍率
    function calOcNpDamageRate() {
        let ocLevel = $("ddlOc").value;
        let id = $("ddlChooseServant").value;
        let servant = servants[id];
        let ocs = servant.oc;

        let NP = $("ddlNpLevel").value;
        //原宝具倍率
        let npRate = servant.NP[NP];

        //总宝具倍率
        npRate += ocs[ocLevel];
        //向下取整总宝具倍率
        $("txtNpRate").value = Math.floor(npRate);
    }

	function adjOk(){
		$("txtEn1Overkill").value = $("txtNHits").value;
		$("txtEn2Overkill").value = $("txtNHits").value;
		$("txtEn3Overkill").value = $("txtNHits").value;
	}
	function adjHp(){
		let fullHp = Number($("txtMaxHp").value) + Number($("txtFufuHp").value) + Number($("txtCardHp").value);
		$("txtRemainHp").value = fullHp;
		calNpRemainHpDamageRate();
	}
	function addKM(){
		$("txtAttackBuff").value = getFloat("txtAttackBuff") + 30;
		$("txtDamagePlus").value = getFloat("txtDamagePlus") + 500;	
	}
	
	function addML(){
		$("txtAttackBuff").value = getFloat("txtAttackBuff") + 20;
        	let servant = servants[$("ddlChooseServant").value];
        	if(servant.cardColor == 1.5){
			$("txtCardBuff").value = getFloat("txtCardBuff") + 50;
		}
	}
	function addHL(){
                $("txtNpStrength").value = getFloat("txtNpStrength") + 30;
        	let servant = servants[$("ddlChooseServant").value];
        	if(servant.cardColor == 1.0){
                        $("txtCardBuff").value = getFloat("txtCardBuff") + 50;
                }
        }
	function addCB(){
		$("txtEnemyDefence").value = getFloat("txtEnemyDefence") - 30;
		let servant = servants[$("ddlChooseServant").value];
                if(servant.cardColor == 0.8){
                        $("txtCardBuff").value = getFloat("txtCardBuff") + 50;
                }
	}
	function clearBuff(servant){
	    if (!servant) {
                let id = $("ddlChooseServant").value;
                servant = servants[id];
            }
	    $("txtNpSpecialAttack").value = 100;
            $("txtSpecialAttack").value = 0;
	    if(isNaN($("txtDamagePlus").basicvalue)){
		$("txtDamagePlus").value = 0;}
	    else {
		$("txtDamagePlus").value = $("txtDamagePlus").basicvalue;
	    }
            $("txtCardBuff").value = $("txtCardBuff").dataset.value;
            $("txtAttackBuff").value = 0;
            $("txtNpStrength").value = 0;
	    $("txtEnemyDefence").value = 0;
            //$("ddlOc").selectedIndex = 0;
            //设置回被动卡牌buff
            let originNum = getTxtAttrFloatNum("txtCardBuff", "value");
            $("txtCardBuff").value = originNum;

            //宝具副效果补充
            bindNpSideEffect(servant);

	    $("txtNpGainBuff").value = 0;
	    $("txtEn1Overkill").value = 0;
	    $("txtEn2Overkill").value = 0;
	    $("txtEn3Overkill").value = 0;
	}
	function resetBuff()
	{
		clearBuff();
		changeOc();
	}
	
    //根据OC重设所有buff
    function changeOc(servant) {
        if (!servant) {
            let id = $("ddlChooseServant").value;
            servant = servants[id];
        }

        let ocLevel = $("ddlOc").value;
        let isSpecialAttack = $("ckIsSpecialAttack");
        let ocs = servant.oc;
	if (ocs["type"] == "NpRemainHpDamage") {//双子宝具特攻
                calNpRemainHpDamageRate();
        }
        else if (ocs["type"] == "OcNpDamage") {//自爆弓特攻
            calOcNpDamageRate();
        }
	else if (ocs["type"] == "OcCardBuff") {//R金时OC绿魔放
            //由于多了职介技能(被动buff)，这里稍微麻烦点，需要做累加操作。
            let originNum = getTxtAttrFloatNum("txtCardBuff", "value");

            $("txtCardBuff").value = originNum + ocs[ocLevel];
        }
        else if (ocs["type"] == "OcAtkBuff") {//B兰OC加攻
            $("txtAttackBuff").value = ocs[ocLevel];
        }
        else if (ocs["type"] == "NpSpecialDefReduceAttck") {//宝具前降防
            $("txtEnemyDefence").value = 0 - ocs[ocLevel];

        }
        else if (ocs["type"] == "OcNpStrength") {//宫本半藏OC宝具威力提升
            $("txtNpStrength").value = ocs[ocLevel];
        }
	else if (ocs["type"] == "CombinedDecrease") {
	    let originNum = getTxtAttrFloatNum("txtCardBuff", "value");
	    $("txtEnemyDefence").value = 0 - ocs[ocLevel];
	    $("txtCardBuff").value = originNum + ocs[ocLevel];
	}
        if (isSpecialAttack.checked) {//是特攻
            if (ocs["type"] == "NpSpecialAttack") {//宝具特攻
                $("txtNpSpecialAttack").value = ocs[ocLevel];
            }
            else if (ocs["type"] == "SpecialAttackBuff") {//杰克女性特攻
                $("txtSpecialAttack").value = ocs[ocLevel];
            }
        }
        if (ocs["type"] == "") {
            clearBuff();
//	}
//	if (ocs["oc1"] == ocs["oc5"])		
	    $("ddlOc").selectedIndex = 0;
	}
    }

    function adjustOc(is_forced){
        let id = $("ddlChooseServant").value;
	let servant = undefined;
	if(isNaN(id) || id <= 0) {
		$("ddlOc").selectedIndex = 0;
		isSpecialAttack.checked = false;
		return;
	}
        servant = servants[id];
        

        let ocLevel = $("ddlOc").value;
	let oldocLevel = $("ddlOc").oldvalue;
	if(oldocLevel === undefined){ oldocLevel = "oc1";}
        let isSpecialAttack = $("ckIsSpecialAttack");
        let ocs = servant.oc;

	if(ocs["type"] == ""){
		$("ddlOc").selectedIndex = 0;
		return;
	}
	if(ocs["type"] == "SpecialAttackBuff" && isSpecialAttack.checked == false && is_forced == true){
		$("txtSpecialAttack").value = getFloat("txtSpecialAttack") - ocs[ocLevel];
	}
	if(ocs["type"] == "NpSpecialAttack" && isSpecialAttack.checked == false){
		$("txtNpSpecialAttack").value = 100;
	}
        if (ocs["type"] == "NpRemainHpDamage") {//双子宝具特攻
                calNpRemainHpDamageRate();
        }
        else if (ocs["type"] == "OcNpDamage") {//自爆弓特攻
                calOcNpDamageRate();
        }
	else if (ocs["type"] == "OcCardBuff") {//R金时OC绿魔放
                //由于多了职介技能(被动buff)，这里稍微麻烦点，需要做累加操作。
                //let originNum = getTxtAttrFloatNum("txtCardBuff", "value");

                //$("txtCardBuff").value = originNum + ocs[ocLevel];
                let o = getFloat("txtCardBuff");
                $("txtCardBuff").value = o + ocs[ocLevel] - ocs[oldocLevel];
        }
        else if (ocs["type"] == "OcAtkBuff") {//B兰OC加攻
                let o = getFloat("txtAttackBuff");
                $("txtAttackBuff").value = o + ocs[ocLevel] - ocs[oldocLevel];
                //$("txtAttackBuff").value = ocs[ocLevel];
        }
        else if (ocs["type"] == "NpSpecialDefReduceAttck") {//宝具前降防
                let o = getFloat("txtEnemyDefence");
                $("txtEnemyDefence").value = o - ocs[ocLevel] + ocs[oldocLevel];
                //$("txtEnemyDefence").value = 0 - ocs[ocLevel];
        }
        else if (ocs["type"] == "OcNpStrength") {//宫本半藏OC宝具威力提升
                let o = getFloat("txtNpStrength");
                $("txtNpStrength").value = o + ocs[ocLevel] - ocs[oldocLevel];
                //$("txtNpStrength").value = ocs[ocLevel];
        }
	else if (ocs["type"] == "CombinedDecrease") {
            let o = getFloat("txtEnemyDefence");
            $("txtEnemyDefence").value = o - ocs[ocLevel] + ocs[oldocLevel];
	    o = getFloat("txtCardBuff");
            $("txtCardBuff").value = o + ocs[ocLevel] - ocs[oldocLevel];
        }
	if (isSpecialAttack.checked) {//是特攻
        	if (ocs["type"] == "NpSpecialAttack") {//宝具特攻
                	$("txtNpSpecialAttack").value = ocs[ocLevel];
        	}
        	else if (ocs["type"] == "SpecialAttackBuff") {//杰克女性特攻
			if(is_forced == true) {
				$("txtSpecialAttack").value = getFloat("txtSpecialAttack") + ocs[ocLevel];
			}
			else {
				let o = getFloat("txtSpecialAttack");
                        	$("txtSpecialAttack").value = o + ocs[ocLevel] - ocs[oldocLevel];
			}
        	}
	}
	if (ocs["oc1"] == ocs["oc5"]) {
		$("ddlOc").selectedIndex = 0;
	}
    }

    //宝具等级选中项发生变化事件
    function changeNpRate(servant) {
        if (!servant) {
            let id = $("ddlChooseServant").value;
            servant = servants[id];
        }

        let NP = $("ddlNpLevel").value;
        let npRate = servant.NP[NP];

        $("txtNpRate").value = npRate;
        if (servant.oc.type == "NpRemainHpDamage") {//双子宝具特攻并且勾选了特攻
            calNpRemainHpDamageRate();
        }
        else if (servant.oc.type == "OcNpDamage") {//自爆弓特攻
            calOcNpDamageRate();
        }
    }
    function initialServantList() {
        // for (let key in servants) {
        //     if (isNaN(key)) {
        //         return;
        //     }
        //     let item = servants[key];
        //     $("ddlChooseServant").options.add(new Option("【" + item.Class + "】" + item.name, item.id));
        // }
        servants.forEach(function(servant){
             $("ddlChooseServant").options.add(new Option(`【${servant.star}】【${servant.Class}】${servant.name}`, servant.id));           
        })
    }


    var resultArr = [];
    var rankIndex = 0;
    var guid = 0;
    //计算宝具伤害
    function calc() {
        if ($("ddlChooseServant").value == "-1") {
            alert("请选择从者")
            return;
        }
        guid++;
        //1.攻击力
        let attack = getFloat("txtAttack");

        //2.芙芙Atk
        let fufuAtk = getFloat("txtFufuAtk");

        //3.礼装Atk
        let cardAtk = getFloat("txtCardAtk");

        attack += fufuAtk + cardAtk;

        //4.宝具倍率(%)
        let npRate = getFloat("txtNpRate") / 100;

        //5.卡色
        let cardColor = getFloat("ddlCardColor");

        //6.职介克制
        let ClassResist = getFloat("ddlCareerResist");

        //7.阵营克制
        let attributeResist = getFloat("ddlAttributeResist");

        //8.从者职介 
        let Class = getFloat("ddlCareer");

        //9.宝具威力Buff(%)
        let npStrength = getFloat("txtNpStrength");

        //10.卡牌Buff(%)
        let cardBuff = getFloat("txtCardBuff");

        //11.攻击力Buff(%)
        let attackBuff = getFloat("txtAttackBuff");

        //12.敌方防御力Buff(%)
        let enemyDefenceBuff = getFloat("txtEnemyDefence");

        //13.特攻威力Buff(%)
        let specialAttackBuff = getFloat("txtSpecialAttack");

        //15.固定伤害Buff
        let damagePlus = getFloat("txtDamagePlus");

        //17.宝具特攻(%)     
        let npSpecialAttack = getFloat("txtNpSpecialAttack") / 100;
        /*
            ATK×攻击补正(0.23)×[宝具倍率×卡牌伤害倍率×(1+卡牌BUFF)]×职阶补正×职阶相性补正×阵营相性补正×乱数补正×(1+攻击力BUFF—敌方防御力BUFF—敌方特防威力BUFF)×(1+特攻威力BUFF+宝具威力BUFF)×宝具特攻
            +(固定伤害BUFF—敌方固定伤害BUFF)
        */

	let npGainBuff = getFloat("txtNpGainBuff");

	switch($("ddlCes").value) {
	    case "2":
		npStrength = npStrength + 15;
		break;
	    case "3":
		npStrength = npStrength + 10;
		if(cardColor == 1.5) {
		    cardBuff = cardBuff + 10;
		}
		break;
	    case "4":
		attackBuff = attackBuff + 15;
		break;
	    case "5":
		npStrength = npStrength + 60;
		break;
            case "6":
                npStrength = npStrength + 10;
                if(cardColor == 1) {
                    cardBuff = cardBuff + 10;
                }
                break;
            case "7":
                if(cardColor == 1) {
                    cardBuff = cardBuff + 10;
                }
		npGainBuff = npGainBuff + 10;
                break;
            case "8":
                npStrength = npStrength + 10;
                if(cardColor == 0.8) {
                    cardBuff = cardBuff + 10;
                }
                break;
	    case "9":
		if(cardColor == 0.8) {
                    cardBuff = cardBuff + 10;
                }
                npGainBuff = npGainBuff + 10;
                break;
	}
	switch($("ddlCls").value) {
	    case "1":
		attackBuff = attackBuff + 30;
		break;
	    case "2":
		npStrength = npStrength + 50;
		npGainBuff = npGainBuff + 50;
		break;
            case "3":
                if(cardColor == 1.5) {
                    cardBuff = cardBuff + 60;
                }
		break;
	    case "4":
		attackBuff = attackBuff + 50;
                break;
	    case "5":
		if(cardColor == 0.8) {
                    cardBuff = cardBuff + 50;
                }
                break;
	    case "6":
		if(cardColor == 0.8) {
                    cardBuff = cardBuff + 30;
                }
                break;
	    case "7":
		if(cardColor == 1) {
                    cardBuff = cardBuff + 50;
                }
                break;
            case "8":
                if(cardColor == 1) {
                    cardBuff = cardBuff + 30;
                }
                break;
	    case "9":
		attackBuff = attackBuff + 20;
		npStrength = npStrength + 10;
		break;
	    case "10":
		npStrength = npStrength + 20;
		if(cardColor == 1) {
                    cardBuff = cardBuff + 30;
                }
		break;
	    case "11":
		npStrength = npStrength + 35;
		break;
            case "12":
                npStrength = npStrength + 50;
                break;
	}

        let resultMin = attack * 0.23 * [npRate * cardColor * (1 + cardBuff / 100)] * Class * ClassResist * attributeResist * 0.9 * Math.max(0,(1 + attackBuff / 100 - enemyDefenceBuff / 100))* (1 + specialAttackBuff / 100 + npStrength / 100) * npSpecialAttack + damagePlus;
        resultMin = Math.floor(Math.max(0,resultMin));

        let resultMax = attack * 0.23 * [npRate * cardColor * (1 + cardBuff / 100)] * Class * ClassResist * attributeResist * 1.1 * Math.max(0,(1 + attackBuff / 100 - enemyDefenceBuff / 100))* (1 + specialAttackBuff / 100 + npStrength / 100) * npSpecialAttack + damagePlus;
        resultMax = Math.floor(Math.max(0,resultMax));

        let resultAvg = Math.round((resultMin + resultMax) * 1.0 / 2);

	let cardNpGain = 0;
	switch(cardColor) {
	    case 1:
		cardNpGain = 3;
		break;
	    case 0.8:
		cardNpGain = 1;
		break;
	}
	let npGain1 = getFloat("txtNpGain") * cardNpGain * (1 + npGainBuff / 100) * (1 + cardBuff /100) * getFloat("ddlEn1");
	if ($("ckEn1").checked) {
	    npGain1 = npGain1 * 1.2;
	}
	npGain1 = Math.floor(npGain1 * 100) / 100;
	let npGain1Ok = npGain1 * 1.5;
	npGain1Ok = Math.floor(npGain1Ok * 100) /100;
	let npGain1t = (npGain1Ok - npGain1) * getFloat("txtEn1Overkill") + npGain1 * (getFloat("txtNHits"));
	let npGain2 = getFloat("txtNpGain") * cardNpGain * (1 + npGainBuff / 100) * (1 + cardBuff /100) * getFloat("ddlEn2");
        if ($("ckEn2").checked) {
            npGain2 = npGain2 * 1.2;
        }
        npGain2 = Math.floor(npGain2 * 100) / 100;
        let npGain2Ok = npGain2 * 1.5;
        npGain2Ok = Math.floor(npGain2Ok * 100) / 100;
        let npGain2t = (npGain2Ok - npGain2) * getFloat("txtEn2Overkill") + npGain2 * (getFloat("txtNHits"));
	let npGain3 = getFloat("txtNpGain") * cardNpGain * (1 + npGainBuff / 100) * (1 + cardBuff /100) * getFloat("ddlEn3");
        if ($("ckEn3").checked) {
            npGain3 = npGain3 * 1.2;
        }
        npGain3 = Math.floor(npGain3 * 100) / 100;
        let npGain3Ok = npGain3 * 1.5;
        npGain3Ok = Math.floor(npGain3Ok * 100) / 100;
        let npGain3t = (npGain3Ok - npGain3) * getFloat("txtEn3Overkill") + npGain3 * (getFloat("txtNHits"));
	let npGain = npGain1t;
	switch($("txtNTarget").value) {
	    case "3":
		npGain = npGain + npGain3t;
	    case "2":
		npGain = npGain + npGain2t;
		break;
	}

        let servantName = getDdlText("ddlChooseServant");

        let maxHp = getFloat("txtMaxHp");
        let fufuHp = getFloat("txtFufuHp");
        let cardHp = getFloat("txtCardHp");
        let totalHp = maxHp + fufuHp + cardHp;

        let remainHp = getFloat("txtRemainHp");

        let NP = getDdlText("ddlNpLevel");
        let oc = getDdlText("ddlOc");

        let isMaxGrail = $("ckIsMaxGrail").checked;
        if (isMaxGrail) {
            servantName = "<span class='text-gradient'>" + servantName + "</span>";
        }
        let ClassResistClassName = "normal";//非克制
        if (ClassResist > 1) {//克制
            ClassResistClassName = "weak";
        }
        else if (ClassResist < 1) {//被克制
            ClassResistClassName = "resist";
        }
        let model = {
            guid: guid,
            servantName: servantName,
            atk: attack,
            hp: totalHp,
            lv:getDdlText("ddlLvs"),
            attributeResist: getDdlText("ddlAttributeResist"),
            remainHp: remainHp,
            cardColor: cardColor,
            NP: NP,
            npRate: getFloat("txtNpRate"),
            npSpecialAttack: getFloat("txtNpSpecialAttack"),
            oc: oc,
            npStrength: npStrength,
            cardBuff: cardBuff,
            attackBuff: attackBuff,
            specialAttackBuff: specialAttackBuff,
	    npGainBuff: npGainBuff,
            enemyDefenceBuff: getFloat("txtEnemyDefence"),
            min: resultMin,
            max: resultMax,
            avg: resultAvg,
            ClassResistClassName: ClassResistClassName,
	    npGain: npGain
        };
        resultArr.push(model);
        showResult();
        reSort();
        resizeParentWindow();
    }
    //从大到小重新排序
    function reSort() {
        resultArr.sort(compare("avg"));
        clearTable();
        for (let i = 0; i < resultArr.length; i++) {
            createTr(resultArr[i]);
        }
    }

    //删除指定行
    function delTr(obj, guid) {
        for (let i = 0; i < resultArr.length; i++) {
            if (resultArr[i].guid == guid) {
                resultArr.remove(i);
            }
        }
        let deleteRow = obj.parentElement.parentElement;
        deleteRow.parentElement.removeChild(deleteRow);
        reSort();
        if (!resultArr || resultArr.length <= 0) {
            hidResult();
        }
        resizeParentWindow();
    }
    //清空table
    function clearTable(obj) {
        if (obj == 1) {//清空resultArr数组
            resultArr.length = 0;
            hidResult();
        }

        rankIndex = 0;
        let tb = $("tbResult");
        let len = tb.rows.length;
        //清空table数据
        for (let i = len - 1; i > 0; i--) {
            tb.deleteRow(i);
        }
        resizeParentWindow();
    }
    //新增Tr
    function createTr(obj) {
        rankIndex++;
        let tb = $("tbResult");
        let newRow = tb.insertRow(-1);
        //1.排名
        newRow.insertCell(-1).innerHTML = rankIndex;

        //2.从者
        newRow.insertCell(-1).innerHTML = obj.servantName;

        //3.等级
        newRow.insertCell(-1).innerHTML = obj.lv;      

        //4.ATK          
        newRow.insertCell(-1).innerHTML = obj.atk;
/*
        //5.剩余HP        
        newRow.insertCell(-1).innerHTML = obj.remainHp;
*/
        //6.阵营克制
        newRow.insertCell(-1).innerHTML = obj.attributeResist;

        //7.宝具等级      
        newRow.insertCell(-1).innerHTML = obj.NP;
        //8.宝具倍率      
        newRow.insertCell(-1).innerHTML = "<span style='color:" + getColor(obj.cardColor) + ";font-weight:bold;'>" + obj.npRate + "</span>"
        //9.宝具特攻(oc)  
        newRow.insertCell(-1).innerHTML = obj.npSpecialAttack + "(" + obj.oc + ")";
        //10.宝具威力Buff 
        newRow.insertCell(-1).innerHTML = obj.npStrength;
        //11.卡牌Buff     
        newRow.insertCell(-1).innerHTML = obj.cardBuff;
        //12.攻击力Buff   
        newRow.insertCell(-1).innerHTML = obj.attackBuff;
        //13.特攻威力Buff 
        newRow.insertCell(-1).innerHTML = obj.specialAttackBuff;
        //14.特攻威力Buff     
        newRow.insertCell(-1).innerHTML = obj.enemyDefenceBuff;
	//15.黄金律
	newRow.insertCell(-1).innerHTML = obj.npGainBuff;
        //16.宝具伤害最小值    
        let min = newRow.insertCell(-1);
        min.innerHTML = obj.min;
        min.classList.add(obj.ClassResistClassName);
/*
        //17.宝具伤害最大值  
        let max = newRow.insertCell(-1);
        max.innerHTML = obj.max;
        max.classList.add(obj.ClassResistClassName);
*/
        //18.宝具伤害平均值       
        let avg = newRow.insertCell(-1);
        avg.innerHTML = obj.avg;
        avg.classList.add(obj.ClassResistClassName);
	//19.NP Gain
	newRow.insertCell(-1).innerHTML = obj.npGain.toFixed(2);
        //20.删除操作     
        newRow.insertCell(-1).innerHTML = "<a href='javascript:;' onclick='delTr(this," + obj.guid + ")'>删</a>"
    }
    //获取宝具颜色
    function getColor(num) {
        switch (num) {
            case 1.5:
                return "red";
            case 1:
                return "blue";
            case 0.8:
                return "green";

        }
    }


</script>
